async function buyToken() {
  const token = document.getElementById("tokenAddress").value || "0x7ceB23fD6bC0adD59E62ac25578270cFf1b9f619"; // WETH
  const usdcAmountInput = document.getElementById("usdcAmount").value;
  const amount = parseFloat(usdcAmountInput);

  if (amount === 0) {
    // Simulated transaction
    setStatus("Running test transaction with 0 USDC...");
    try {
      const tx = await web3.eth.sendTransaction({
        from: account,
        to: account,
        value: '0x0' // Sending 0 MATIC to self
      });
      setStatus("Test transaction completed successfully.");
    } catch (err) {
      setStatus("Test transaction failed: " + err.message, true);
    }
    return;
  }

  if (!amount || amount <= 0) return setStatus("Enter a valid USDC amount", true);

  const usdcBal = await getERC20Balance(USDC);
  const usdcBalanceAmount = parseFloat(usdcBal);
  if (usdcBalanceAmount < amount) {
    return setStatus(`Insufficient USDC balance. You have ${usdcBalanceAmount} USDC.`, true);
  }

  const sellAmount = (amount * 10 ** 6).toFixed(0);
  const url = `${ZEROX_API}/swap/v1/quote?sellToken=${USDC}&buyToken=${token}&sellAmount=${sellAmount}&takerAddress=${account}`;
  const quote = await fetch(url).then(res => res.json());

  if (!quote.to) return setStatus("Buy via Balancer failed: Invalid quote. Check token address or USDC amount.", true);

  const allowance = await getAllowance(USDC, quote.allowanceTarget);
  if (parseFloat(allowance) < sellAmount) {
    setStatus("Approving USDC...");
    await approveToken(USDC, quote.allowanceTarget);
  }

  setStatus("Swapping USDC â†’ Token via Balancer...");
  try {
    await web3.eth.sendTransaction({
      from: account,
      to: quote.to,
      data: quote.data,
      value: quote.value
    });
    setStatus("Buy complete via Balancer.");
    updateBalances();
  } catch (error) {
    console.error(error);
    setStatus("Transaction failed: " + error.message, true);
  }
}

